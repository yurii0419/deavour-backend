name: Check for Pivotal Tracker Story ID

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  pivotal_tracker_check:
    runs-on: ubuntu-latest
    steps:
    - name: Extract Story ID
      id: extract_story_id
      run: |
        PR_BODY=$(curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                    -H "Accept: application/vnd.github.v3+json" \
                    https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }} \
                    | jq -r '.body')

        STORY_ID=$(echo "$PR_BODY" | grep -oP '(?<=PT-)\d+|(?<=https://www\.pivotaltracker\.com/story/show/)\d+' | head -n1)

        if [ -z "$STORY_ID" ]; then
          echo "No Pivotal Tracker Story ID found." >&2
          exit 1
        fi
        echo "story_id=$STORY_ID" >> $GITHUB_ENV

    - name: Validate Story in Pivotal Tracker
      run: |
        STORY_ID=${{ env.story_id }}
        RESPONSE=$(curl -s -H "X-TrackerToken: ${{ secrets.PIVOTAL_TRACKER_API_TOKEN }}" \
                    "https://www.pivotaltracker.com/services/v5/stories/$STORY_ID")
        
        if echo "$RESPONSE" | jq -e '.kind == "story" and .id == '"$STORY_ID"'' > /dev/null; then
          echo "Valid Pivotal Tracker Story ID found: $STORY_ID"
        else
          echo "Invalid Pivotal Tracker Story ID: $STORY_ID" >&2
          exit 1
        fi
