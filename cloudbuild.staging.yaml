steps:
- name: 'gcr.io/cloud-builders/npm'
  args: ['install']
- name: 'gcr.io/cloud-builders/npm'
  args: ['run', 'create-env']
  env:
    - 'DATABASE_URL=${_DATABASE_URL}'
    - 'DATABASE_URL_TEST=${_DATABASE_URL_TEST}'
    - 'NODE_ENV=${_NODE_ENV}'
    - 'PORT=${_PORT}'
    - 'SECRET_KEY=${_SECRET_KEY}'
    - 'TOKEN_EXPIRATION=${_TOKEN_EXPIRATION}'
    - 'TOKEN_ISSUER=${_TOKEN_ISSUER}'
    - 'TOKEN_AUDIENCE=${_TOKEN_AUDIENCE}'
    - 'MAILER_EMAIL=${_MAILER_EMAIL}'
    - 'ADMIN_EMAIL=${_ADMIN_EMAIL}'
    - 'SALES_MAILER_EMAIL=${_SALES_MAILER_EMAIL}'
    - 'SENDGRID_API_KEY=${_SENDGRID_API_KEY}'
    - 'APP_NAME=${_APP_NAME}'
    - 'APP_URL=${_APP_URL}'
    - 'API_DOCUMENTATION_URL=${_API_DOCUMENTATION_URL}'
    - 'PUB_SUB_TOPIC_ID=${_PUB_SUB_TOPIC_ID}'
    - 'FIREBASE_PRIVATE_KEY=${_FIREBASE_PRIVATE_KEY}'
    - 'FIREBASE_PROJECT_ID=${_FIREBASE_PROJECT_ID}'
    - 'FIREBASE_CLIENT_EMAIL=${_FIREBASE_CLIENT_EMAIL}'
    - 'STORAGE_BUCKET=${_STORAGE_BUCKET}'
    - 'DHL_API_URL=${_DHL_API_URL}'
    - 'DHL_API_KEY=${_DHL_API_KEY}'
    - 'FIREBASE_STORAGE_ENVIRONMENT=${_FIREBASE_STORAGE_ENVIRONMENT}'
    - 'COMPANY_INVITE_SECRET_KEY=${_COMPANY_INVITE_SECRET_KEY}'
    - 'JTL_API_URL=${_JTL_API_URL}'
- name: 'gcr.io/cloud-builders/npm'
  args: ['run', 'migrate']
- name: 'gcr.io/cloud-builders/npm'
  args: ['test']
- name: 'gcr.io/cloud-builders/npm'
  args: ['run', 'codecov-coverage']
  env:
    - 'CODECOV_TOKEN=${_CODECOV_TOKEN}'
- name: 'gcr.io/cloud-builders/npm'
  args: ['run', 'build']
- name: 'gcr.io/cloud-builders/docker'
  args: [ 'build', '-t', 'gcr.io/$PROJECT_ID/endeavour-api-staging', '.' ]
- name: 'gcr.io/cloud-builders/docker'
  args: [ 'push', 'gcr.io/$PROJECT_ID/endeavour-api-staging']
- name: "gcr.io/cloud-builders/gcloud"
  args: ['run', 'deploy', 'endeavour-api-staging', '--image', 'gcr.io/$PROJECT_ID/endeavour-api-staging', '--region', 'europe-west3', '--platform', 'managed', '--allow-unauthenticated', '--max-instances=50']
images:
  - 'gcr.io/$PROJECT_ID/endeavour-api-staging'